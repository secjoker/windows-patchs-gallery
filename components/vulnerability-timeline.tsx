"use client";

import { useEffect, useRef } from 'react';
import { format } from 'date-fns';
import { zhCN } from 'date-fns/locale';
import { cn } from "@/lib/utils";

export interface TimelineEvent {
  date: Date;
  title: string;
  description?: string;
  kbNumber?: string;
  isHighlighted?: boolean;
}

interface VulnerabilityTimelineProps {
  events: TimelineEvent[];
  isDarkMode?: boolean;
}

const VulnerabilityTimeline = ({ events, isDarkMode = false }: VulnerabilityTimelineProps) => {
  // 按日期排序事件
  const sortedEvents = [...events].sort((a, b) => a.date.getTime() - b.date.getTime());
  
  return (
    <div className="relative mt-4 mb-10">
      {/* 时间线 */}
      <div 
        className={cn(
          "absolute left-7 top-0 h-full w-0.5", 
          isDarkMode ? "bg-slate-700" : "bg-slate-200"
        )}
      />
      
      {/* 事件列表 */}
      <div className="space-y-8">
        {sortedEvents.map((event, index) => (
          <div key={index} className="relative pl-10">
            {/* 日期指示器 */}
            <div 
              className={cn(
                "absolute left-0 flex h-14 w-14 items-center justify-center rounded-full text-xs font-semibold",
                event.isHighlighted 
                  ? isDarkMode 
                    ? "bg-blue-900/75 text-blue-100 ring-2 ring-blue-500" 
                    : "bg-blue-50 text-blue-700 ring-2 ring-blue-500"
                  : isDarkMode 
                    ? "bg-slate-800 text-slate-200" 
                    : "bg-white text-slate-700 shadow"
              )}
            >
              <div className="text-center leading-tight">
                <div className="text-[10px] uppercase">{format(event.date, 'MMM', { locale: zhCN })}</div>
                <div className="text-lg font-bold">{format(event.date, 'd')}</div>
                <div className="text-[10px]">{format(event.date, 'yyyy')}</div>
              </div>
            </div>
            
            {/* 事件内容 */}
            <div 
              className={cn(
                "rounded-xl p-4",
                event.isHighlighted 
                  ? isDarkMode 
                    ? "bg-blue-900/10 ring-1 ring-blue-500/30" 
                    : "bg-blue-50 ring-1 ring-blue-200"
                  : isDarkMode 
                    ? "bg-slate-800/50" 
                    : "bg-white shadow-sm"
              )}
            >
              <div className="flex items-center justify-between">
                <h3 className={cn(
                  "font-medium", 
                  isDarkMode ? "text-slate-100" : "text-slate-900"
                )}>
                  {event.title}
                </h3>
                {event.kbNumber && (
                  <span className={cn(
                    "rounded px-2 py-1 text-xs font-medium",
                    isDarkMode ? "bg-slate-700 text-slate-300" : "bg-slate-100 text-slate-700"
                  )}>
                    {event.kbNumber}
                  </span>
                )}
              </div>
              
              {event.description && (
                <p className={cn(
                  "mt-1 text-sm",
                  isDarkMode ? "text-slate-400" : "text-slate-600"
                )}>
                  {event.description}
                </p>
              )}
              
              <div className="mt-2 text-xs text-right">
                <time 
                  dateTime={event.date.toISOString()} 
                  className={isDarkMode ? "text-slate-500" : "text-slate-400"}
                >
                  {format(event.date, 'yyyy年MM月dd日')}
                </time>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

export default VulnerabilityTimeline; 